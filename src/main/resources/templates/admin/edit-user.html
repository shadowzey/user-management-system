<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑用户 - 用户管理系统</title>
    <!-- 使用本地静态资源 -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/all.min.css" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
    <link href="/css/admin.css" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <!-- 侧边栏 -->
        <div class="admin-sidebar">
            <div class="site-title">
                <h4>用户管理系统</h4>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/admin">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>控制面板</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/users">
                        <i class="fas fa-users"></i>
                        <span>用户管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/logs">
                        <i class="fas fa-history"></i>
                        <span>操作日志</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="fas fa-home"></i>
                        <span>返回首页</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="adminLogoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>退出登录</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="admin-content">
            <div class="admin-header">
                <h2 class="admin-title">编辑用户</h2>
                <div class="user-info">
                    <span id="adminUsername"></span>
                </div>
            </div>
            
            <!-- 用户信息表单 -->
            <div class="admin-card">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4 id="editingUserTitle">编辑用户信息</h4>
                    </div>
                    <div class="col-md-6 text-end">
                        <a href="/admin/users" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> 返回用户列表
                        </a>
                    </div>
                </div>
                
                <form id="userEditForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="username" disabled>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="email" disabled>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="realName" class="form-label">真实姓名</label>
                            <input type="text" class="form-control" id="realName" name="realName">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phoneNumber" class="form-label">手机号码</label>
                            <input type="text" class="form-control" id="phoneNumber" name="phoneNumber">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="address" class="form-label">地址</label>
                            <input type="text" class="form-control" id="address" name="address">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="city" class="form-label">城市</label>
                            <input type="text" class="form-control" id="city" name="city">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="postalCode" class="form-label">邮政编码</label>
                            <input type="text" class="form-control" id="postalCode" name="postalCode">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="country" class="form-label">国家</label>
                            <input type="text" class="form-control" id="country" name="country">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="bio" class="form-label">个人简介</label>
                            <textarea class="form-control" id="bio" name="bio" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enabled" name="enabled">
                                <label class="form-check-label" for="enabled">账户状态（启用/禁用）</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 保存更改
                            </button>
                            <a href="/admin/users" class="btn btn-outline-secondary ms-2">
                                <i class="fas fa-times"></i> 取消
                            </a>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- 用户日志 -->
            <div class="admin-card mt-4">
                <h4 class="mb-4">用户活动日志</h4>
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>操作</th>
                                <th>IP地址</th>
                                <th>详情</th>
                                <th>状态</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody id="userLogsTable">
                            <tr>
                                <td colspan="5" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 使用本地JavaScript库 -->
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/admin.js"></script>
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', async function() {
            // 检查管理员权限
            if (!await checkAdminAuth()) return;
            
            // 显示管理员用户名
            const userData = await getCurrentUser();
            if (userData) {
                document.getElementById('adminUsername').textContent = userData.username;
            }
            
            // 获取用户ID
            const urlParts = window.location.pathname.split('/');
            const userId = urlParts[urlParts.length - 1];
            
            // 加载用户信息
            async function loadUserDetails() {
                const userDetails = await fetchUserDetails(userId);
                if (!userDetails) {
                    alert('获取用户信息失败');
                    window.location.href = '/admin/users';
                    return;
                }
                
                // 设置页面标题
                document.getElementById('editingUserTitle').textContent = `编辑用户: ${userDetails.username}`;
                
                // 填充表单
                document.getElementById('username').value = userDetails.username;
                document.getElementById('email').value = userDetails.email;
                document.getElementById('realName').value = userDetails.realName || '';
                document.getElementById('phoneNumber').value = userDetails.phoneNumber || '';
                document.getElementById('address').value = userDetails.address || '';
                document.getElementById('city').value = userDetails.city || '';
                document.getElementById('postalCode').value = userDetails.postalCode || '';
                document.getElementById('country').value = userDetails.country || '';
                document.getElementById('bio').value = userDetails.bio || '';
                document.getElementById('enabled').checked = userDetails.enabled;
                
                // 格式化日期时间函数
            function formatDateTime(timestamp) {
                if (!timestamp) return '-';
                
                // 处理ISO格式的时间字符串
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    console.error('无效的时间格式:', timestamp);
                    return timestamp; // 返回原始值
                }
                
                // 格式化为本地时间格式
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            }
            
            // 加载用户日志
                console.log('开始加载用户日志, 用户ID:', userId);
                const userLogs = await fetchUserLogs(userId);
                console.log('获取到的用户日志:', userLogs);
                
                if (userLogs && userLogs.length > 0) {
                    const logsHtml = userLogs.map(log => {
                        console.log('处理日志项:', log);
                        return `
                        <tr>
                            <td>${log.action || '-'}</td>
                            <td>${log.ipAddress || '-'}</td>
                            <td>${log.details || '-'}</td>
                            <td>
                                <span class="user-status-badge ${log.status === 'SUCCESS' ? 'status-active' : 'status-inactive'}">
                                    ${log.status || '-'}
                                </span>
                            </td>
                            <td>${formatDateTime(log.timestamp)}</td>
                        </tr>
                        `;
                    }).join('');
                    
                    document.getElementById('userLogsTable').innerHTML = logsHtml;
                } else {
                    document.getElementById('userLogsTable').innerHTML = '<tr><td colspan="5" class="text-center">暂无日志记录</td></tr>';
                }
            }
            
            // 加载用户信息
            loadUserDetails();
            
            // 表单提交事件
            document.getElementById('userEditForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const userData = {
                    realName: document.getElementById('realName').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    postalCode: document.getElementById('postalCode').value,
                    country: document.getElementById('country').value,
                    bio: document.getElementById('bio').value,
                    enabled: document.getElementById('enabled').checked
                };
                
                if (await updateUser(userId, userData)) {
                    alert('用户信息更新成功');
                    // 重新加载用户信息
                    loadUserDetails();
                } else {
                    alert('用户信息更新失败');
                }
            });
            
            // 退出登录按钮
            document.getElementById('adminLogoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });
        });
    </script>
</body>
</html>
